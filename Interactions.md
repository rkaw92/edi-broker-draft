# Notes
* Only special headers, prefixed by `X-EDI-`, are used by the broker/routing infrastructure.
* Our headers have a naming standard that corresponds to their behavior:
    * `X-EDI-Peer-*` - removed at every hop when processing the inbound message; may be recomputed and a new value may be sent to the next hop. This is used for transmitting data that is relevant only to the direct communication between the peers transmitting the message (e.g. origin-broker, broker-target, or broker-broker), such as when performing authentication of the client (connecting side) to the server (listening side).
    * `X-EDI-Target-*` - removed and used only when delivering to the target (the ultimate hop). Meant for options that modify the actual processing of the message when leaving the routing path, such as overriding some parameters of the final HTTP call.
    * `X-EDI-Message-*` - persisted throughout the flow and not removed; these are delivered to the target, as well.
* Headers are generally case-insensitive and order-insensitive in HTTP, but brokers SHOULD NOT reorder or alter headers if at all possible (with the exception of our custom headers) for the users' convenience. For example, a developer on either side of an exchange may wish to diff two messages to detect problems, and it is beneficial if the only differences that show up stem from our custom headers and well-known processing rules, not from any additional mangling.

# All supported headers
* `X-EDI-Peer-Identity` - identifies the client of the HTTP connection to the server; used instead of TLS Client Certificates due to their poor UX and developer experience. The value is a JSON Web Token.
* `X-EDI-Target-Path` - overrides the final request path to be used when delivering the message to the target. The value is a relative path like `/custom/path/edi.php`.
* `X-EDI-Message-ID` - establishes a message identity for use with deduplication / idempotent processing. The ID can be any textual value; a common choice is a UUID. This must be generated by the Origin, and cannot be made up by brokers.

# Message from partner A to partner B

## Origin to broker
* POST /route/by/gln/from/1/to/2
    * 1 and 2 are GLNs
* Authorization: by header `X-EDI-Peer-Identity: <partner A client token here>`
    * The usual "Authorization" header is not used, as it may be required by the target and should not be mangled
* Optional path override: by header `X-EDI-Target-Path: /target/path`
    * This allows overriding the request path ("uri") at the target server in case it doesn't accept `/route/by/gln/from/1/to/2`

## Broker to broker
* POST /route/by/gln/from/1/to/2
* Authorization: by header `X-EDI-Peer-Identity: <connecting broker's token here>`

## Broker to target
* POST /route/by/gln/from/1/to/2, or to another URL if overridden by `X-EDI-Target-Path`
    * `X-EDI-Target-Path` is stripped from the request
* Authorization: by header `X-EDI-Peer-Identity: <connecting broker's token here>`, unless explicitly disabled

# General message processing rules for brokers:

## Input
* Check authorization
    * Validate token (must be present, bear a valid signature, and be within the validity timeframe of not-before and expiry)
        * If invalid, return HTTP 401 and indicate how to authenticate
    * Check local and remote routes
        * If a local route exists, set next-hop type to Target, and populate next-hop data
        * If a remote route is known, set next-hop type to Broker, and populate next-hop data
* Remove all `X-EDI-Peer-*` headers from the message

## Output to Broker
* Add `X-EDI-Peer-Identity` as required by the next-hop
* Send

## Output to Target
* Replace the request path by the value of `X-EDI-Target-Path` if present 
* Remove all `X-EDI-Target-*` headers from the message
* Send

# Interpretation of immediate HTTP responses
* 200-299 - OK, mark the message as processed
* 401 - temporary failure, requires retry after correcting authentication problems (the connecting broker's credentials must be wrong)
* 403 - persistent failure, means the Origin is not authorized to talk to Target
* 500, 503 - temporary failure
